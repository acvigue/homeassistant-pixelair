name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: release_notes
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });

            const previousTag = releases.length > 0 ? releases[0].tag_name : null;
            const currentTag = context.ref.replace('refs/tags/', '');

            let releaseNotes = '';

            if (previousTag) {
              const { data: comparison } = await github.rest.repos.compareCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                base: previousTag,
                head: currentTag
              });

              const commits = comparison.commits
                .map(commit => `- ${commit.commit.message.split('\n')[0]}`)
                .join('\n');

              releaseNotes = `## What's Changed\n\n${commits}\n\n**Full Changelog**: https://github.com/${context.repo.owner}/${context.repo.repo}/compare/${previousTag}...${currentTag}`;
            } else {
              releaseNotes = `## Initial Release\n\nFirst release of the PixelAir Home Assistant integration.`;
            }

            core.setOutput('notes', releaseNotes);

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          body: |
            ## PixelAir for Home Assistant

            Install via HACS by adding `acvigue/homeassistant-pixelair` as a custom repository.

            ### Installation

            1. Open HACS in Home Assistant
            2. Click the three dots menu â†’ Custom repositories
            3. Add `acvigue/homeassistant-pixelair` with category "Integration"
            4. Search for "PixelAir" and click Download
            5. Restart Home Assistant
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
